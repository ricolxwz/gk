---
title: 数据库:完整性约束
comments: true
---

## 概念

完整性约束是数据库中的每一个实例都符合的一个条件. 又可以被称为ICs, Integrity Constraints. ICs是在数据库最初设计的时候就需要考虑并定义的内容, 可以通过`CREATE TABLE`的命令实现. 也可以在任意时间通过`ALTER TABLE <table_name> ADD/ALTER <constraints>`来添加或更新ICs. 

???+ warning "注意"

    在执行完整性约束修改/添加命令的时候, 数据库会先确保关系满足指定的约束:
    
    - 如果满足, 约束将添加到关系中
    - 如果不满足, 命令会被拒绝

一个合法的关系实例是满足所有指定ICs的关系实例, 但是并不是所有的时候都满足, 可以存在暂时不满足的情况. 如在同一个事务中先插入一个新的订单, 然后再插入对应的客户信息时, 可能会出现一种暂定的状态: 订单记录已经插入, 但是对应的客户记录还没有插入, 这时候客户记录可能不满足完整性约束.

## 数据库中的ICs

在数据库中, ICs在数据库结构设计阶段就被声明了. 数据库的设计者应该确保ICs之前互相不抵触, 这可以通过技术实现自动化检测, 但是开销太大. 数据库会在某一部分发生改变的时候进行ICs检测. 我们也可以声明ICs检测的时间, 如在紧贴着一条SQL语句或者在某个事务结束的时候. 如果违法了ICs, 可能的响应方式有:

- 拒绝当前数据库操作, 不执行
- 中止整一个事务, 回滚所有在同一个事务中已经执行的操作 
- 执行一系列维护指令

## 事务

事务就是一组被作为整体执行的SQL语句, 这个操作具有原子性. 其语法为:

```sql
BEGIN;
    <statement1>;
    <statement2>;
    <statement3>;
COMMIT;
```

## 类型

- 静态ICs

    静态ICs描述了数据库中的每一个合法实例都必须满足的条件. 这意味着静态完整性约束是状态无关的. 当插入, 删除或者更新操作违反了这些约束的时候, 这些操作会被禁止. 静态ICs有四种类型: [域约束(Domain Constraints)](#域约束), [键约束](#键约束)及[参照完整性约束(Key Constraints & Referential Integrity)](#参与完整性约束), 语义完整性约束(Semantic Integrity Constraints), 断言(Assertions).

- 动态ICs

    这些约束是基于数据库状态变化的谓词, 捕获两个或多个状态之间的条件. 因此, 动态ICs是状态相关的, 例如触发器, 它们会在数据库状态发生变化的时候执行特定的操作.

## 域约束

数据库中的每一个字段都应该具有合适的数据类型. 每当向数据库中插入数据的时候, 系统会检查数据是否符合该字段定义的数据类型, 这种检查是自动进行的, 确保不符合的数据无法插入. 在执行查询的时候, 数据库系统会检查各个字段之间的值的比较是否有意义, 例如, 防止在比较字符串和数字的时候出现错误. 

SQL的DDL语句允许字段在`CREATE TABLE`语句中被进一步约束: 

- `DEFAULT`: 若在`INSERT`语句中值被省略的话字段的默认值
- `NOT NULL`: 字段值不允许为`NULL`
- `NULL`: 字段的值可以是`NULL`, 默认情况

???+ example "例子"

    ```sql
    CREATE TABLE Student
    (
        sid INTEGER NOT NULL,
        name VARCHAR(20) NOT NULL,
        semester INTEGER DEFAULT 1,
        birthday DATE NULL,
        country VARCHAR(20)
    )
    ```

除了数据类型约束以外, 还可以使用`CHECK`语句对字段的取值范围进行约束. 

???+ example "例子"

    ```sql
    CREATE TABLE Student
    (
        sid INTEGER NOT NULL,
        name VARCHAR(20) NOT NULL,
        semester INTEGER DEFAULT 1,
        birthday DATE NULL,
        country VARCHAR(20),
        grade CHAR(1) CHECK(grade IN ('F', 'P', 'C', 'D', 'H')),
        age INTERGER CHECK(age >= 0)
    )
    ```

### 自定义域

自定义域是为某个字段自定义的数据类型, 取值范围等域约束的总和. 

???+ example "例子"

    先来看没有自定义域下的写法:

    ```sql
    CREATE TABLE Student (
        sid INTEGER NOT NULL,
        name VARCHAR(20) NOT NULL,
        grade CHAR (1) DEFAULT ’P’ CHECK (grade IN (‘F’,’P’,’C’,’D’,’H’)),
        birthday DATE );
    ```

    自定义域`Grade`: `CREATE DOMAIN Grade CHAR(1) DEFAULT ’P’ CHECK(VALUE IN (‘F’,’P’,’C’,’D’,’H’))`, 然后可以在创建表的时候这么写:

    ```sql
    CREATE TABLE Student (
        sid INTEGER NOT NULL,
        name VARCHAR(20) NOT NULL,
        grade Grade,
        birthday DATE );
    ```

## 键约束

在SQL中, 我们使用`PRIMARY KEY`和`UNIQUE`语句处理键约束, 主键默认为`UNIQUE`和`NOT NULL`. 一个表中可以有多个候选键(可以使用`UNIQUE`定义), 但是只能有一个主键. 若主键由多个字段构成, 则需要按照下述方式声明主键:

???+ example "例子"

    ```
    CREATE TABLE Boat
    (
        name VARCHAR(20),
        colour VARCHAR(20),
        PRIMARY KEY (name, colour)
    );
    ```

## 参与完整性约束

参与完整性约束确保在数据库中, 表与表之间通过外键建立的饮用关系始终保持一致. 对于每一个子表/从属表中的一个元组的外键为$\alpha$, 则一定有一个父表/被引用表的元组其被引用的属性的值为$\alpha$.