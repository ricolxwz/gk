---
title: 数据库:事务
comments: true
---

不是所有的数据库操作都是原子性的. 我们需要更加复杂的多步骤的原子性操作. 如, 买房子, 银行转账, 网上交易等等. 没有事务会怎么样呢? A账户给B账户转账100美元, A账户上的前顺利更新-100美元, 但是B账户还没更新, 系统先坏了, 这个时候B账户上没有更新+100美元. 解决方法就是将操作"A账户上的钱-100美元", "B账户上的前+100美元"组成一个原子操作然后执行. 

数据库事务, Transaction, 是访问并可能操作各种数据项的一个数据库操作序列, 这些操作要么全部执行, 要么全部不执行, 是一个不可分割的工作单位. 事务由事务开始和事务结束之间执行的全部数据库操作组成.[^1]

## 属性[^2]

事务需要有一些必须的属性, 被称为ACID.

- 原子性, Atomicity: 一个事务要不全部执行, 要不全部不执行. 事务在执行过程中发生错误, 会被回滚到事务开始前的状态, 就像这个事务从来没有执行过一样
- 一致性, Consistency: 在事务开始之前和事务结束之后, 数据库的完整性没有被破坏. 这表示写入的资料必须完全符合所有的预设约束, 触发器, 级联回滚等
- 隔离性, Isolation: 数据库允许多个并发事务同时对其数据进行读写和修改的能力, 隔离性可以防止多个事务并发执行时由于交叉执行而导致数据的不一致. 即并发事务的结果和串行事务的结果是相同的. 事务隔离分为不同级别, 包括未提交读, 提交读, 可重复读和串行化
- 持久性, Durability: 事务处理结束后, 对数据的修改是永久的, 即便系统故障也不会丢失

## 一致性

假设数据库在初始状态是一致的(即满足所有的约束), 当事务结束的时候, 若:

- 所有的约束都被满足
- 状态满足预期效果

则称事务是一致的.

每个事务都应该保持数据库的一致性. 确保事务的一致性是应用开发者的责任, 数据库无法修正编写不良的逻辑, 例如, 从账户A中取出100美元, 只向账户B中存入90美元, 而数据库系统是无法自动修正这个问题的.

???+ tip "Tip"

    我们可以设置什么时间点确保数据库一致. 如[图](https://img.ricolxwz.io/a42d73224cbdf35a36d1fa913bd09ca7.png), 参考[约束检查的时间](/数据库/完整性约束/#约束检查的时间).

## 原子性

在现实世界中, 事务都是要不完全发生, 要不完全不发生, 就如银行转账, 要不取款和存款都发生, 要不两者都不发生, 部分完成的事务可能造成不正确的数据库状态. 

DBMS实现原子性的方法就是记录所有的可能需要撤销/重做的操作. 例如, 在发生故障的时候, 所有未提交的事务操作都会被撤销(undo), 将已经执行的操作回滚到事务开始之前的状态. 在某些情况下, 还可以重做(redo), 这是指在事务已经提交后, 由于系统奔溃等原因, 数据库中的数据没有正确保存, 此时通过重做操作, 重新应用已提交的事务所做的更改.

???+ abstract "总结"

    - 撤销: 用于未提交的事务, 是回滚事务的更改
    - 重做: 用于已提交的事务, 是重新应用事务的更改

### 提交和中止

- 提交: 如果一个事务顺利结束, 则称之为已经提交
- 中止: 如果一个事务没有顺利结束, 则称之为已经中止

中止的原因有:

- 系统故障, 如断电
- 事务由系统中止, 如
    - 死锁
    - 连接超时
    - 不符合约束
- 事务要求回滚

### SQL写事务

在SQL中, 与事务有关的命令有三个:

- `BEGIN`
- `COMMIT`: 用于请求提交当前的事务
- `ROLLBACK/ABORT`: 造成当前的事务中止

???+ example "例子1"

    === "例子1"

        初始表:

        |UoS|LecturerID|
        |-|-|
        |COMP9120|3456|
        |INFO1234|4567|

        执行:

        ```sql
        BEGIN;
        UPDATE Course SET lecturerId=1234 WHERE uosCode=‘COMP9120’;
        COMMIT;
        SELECT lecturerId FROM Course WHERE uosCode=‘COMP9120’;
        ```

        最终的结果是`1234`.

    === "例子2"

        初始表:

        |UoS|LecturerID|
        |-|-|
        |COMP9120|3456|
        |INFO1234|4567|

        执行:

        ```sql
        BEGIN;
        UPDATE Course SET lecturerId=1234 WHERE uosCode=‘COMP9120’;
        ROLLBACK;
        SELECT lecturerId FROM Course WHERE uosCode=‘COMP9120;
        ```

        最终的结果是`3456`.

    === "例子3"

        初始表:

        |UoS|LecturerID|
        |-|-|
        |COMP9120|3456|
        |INFO1234|4567|

        执行:

        ```sql
        BEGIN;
        UPDATE Course SET lecturerId=4567 WHERE uosCode=‘COMP9120’;
        SELECT lecturerId FROM Course WHERE uosCode=‘COMP9120’;
        COMMIT;
        ```

        最终的结果是`3456`.       

[^1]: 数据库事务. (不详). 百度百科. 取读于 2024年9月30日, 从 https://baike.baidu.hk/item/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BA%8B%E5%8A%A1/9744607
[^2]: ACID. (2023). 收入 维基百科，自由的百科全书. https://zh.wikipedia.org/w/index.php?title=ACID&oldid=76893082